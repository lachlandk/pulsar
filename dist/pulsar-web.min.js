/*!
 * @licence
 * Pulsar.js - A javascript data visualisation framework
 * Copyright (C) 2021  Lachlan Dufort-Kennett
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/
window.Pulsar=function(){const t=function(){const t={setupProperties(i,r,s){for(const o of Object.keys(e[r])){const a=e[r][o],n=Object.keys(s).includes(o),h=[i,o,a.type];a.multi?h.push(...n?Array.isArray(s[o])?s[o]:[s[o]]:a.value):h.push(n?s[o]:a.value),Object.keys(e[r][o]).includes("extra")&&h.push(a.extra),t[a.setter](...h)}},setAxesProperty(t,e,i,...r){if(1===r.length&&typeof r[0]===i)t[e]={x:r[0],y:r[0]};else{if(2!==r.length||typeof r[0]!==i||typeof r[1]!==i)throw`Error setting axes property ${e}: Unexpected value ${JSON.stringify(r)}.`;t[e]={x:r[0],y:r[1]}}t._updateBackground()},setSingleProperty(t,e,i,r){if(typeof r!==i)throw`Error setting single property ${e}: Unexpected type "${"string"==typeof r?r:JSON.stringify(r)}".`;t[e]=r},setArrayProperty(t,e,i,r,s){if(!Array.isArray(r))throw`Error setting array property ${e}: "${"string"==typeof r?r:JSON.stringify(r)}" is not an array.`;if(r.length!==s)throw`Error setting array property ${e}: "${JSON.stringify(r)}" is not of length ${s}`;for(const t of r)if(typeof t!==i)throw`Error setting array property ${e}: "Unexpected type "${"string"==typeof t?t:JSON.stringify(t)}" in array.`;t[e]=r},setChoiceProperty(t,e,i,r,s){if(typeof r!==i)throw`Error setting choice property ${e}: Unexpected type "${"string"==typeof r?r:JSON.stringify(r)}".`;{let i=!1;for(const o of s)r===o&&(t[e]=r,i=!0);if(!i)throw`Error setting choice property ${e}: Invalid choice "${"string"==typeof r?r:JSON.stringify(r)}".`}},setPlotDataProperty(i,r,s,o){const a=e.ResponsivePlot2DTrace[s];if(void 0===i.plotData[r])throw`Error setting plotData property ${s}: Invalid trace ID "${"string"==typeof r?r:JSON.stringify(r)}"`;{const e=[i.plotData[r],s,a.type,o];Object.keys(a).includes("extra")&&e.push(a.extra),t[a.setter](...e),i._updatePlottingData()}}},e={ResponsiveCanvas:{origin:{value:[0,0],type:"number",setter:"setAxesProperty",multi:!0}},ResponsivePlot2D:{majorTicks:{value:[!0,!0],type:"boolean",setter:"setAxesProperty",multi:!0},minorTicks:{value:[!1,!1],type:"boolean",setter:"setAxesProperty",multi:!0},majorTickSize:{value:[5,5],type:"number",setter:"setAxesProperty",multi:!0},minorTickSize:{value:[1,1],type:"number",setter:"setAxesProperty",multi:!0},majorGridlines:{value:[!0,!0],type:"boolean",setter:"setAxesProperty",multi:!0},minorGridlines:{value:[!1,!1],type:"boolean",setter:"setAxesProperty",multi:!0},majorGridSize:{value:[5,5],type:"number",setter:"setAxesProperty",multi:!0},minorGridSize:{value:[1,1],type:"number",setter:"setAxesProperty",multi:!0},gridScale:{value:[50,50],type:"number",setter:"setAxesProperty",multi:!0}},ResponsivePlot2DTrace:{traceColour:{value:"blue",type:"string",setter:"setSingleProperty"},traceStyle:{value:"solid",type:"string",setter:"setChoiceProperty",extra:["solid","dotted","dashed","dashdot","none"]},traceWidth:{value:3,type:"number",setter:"setSingleProperty"},markerColour:{value:"blue",type:"string",setter:"setSingleProperty"},markerStyle:{value:"none",type:"string",setter:"setChoiceProperty",extra:["circle","plus","cross","arrow","none"]},markerSize:{value:1,type:"number",setter:"setSingleProperty"},visibility:{value:!0,type:"boolean",setter:"setSingleProperty"},parameterRange:{value:[0,1],type:"number",setter:"setArrayProperty",extra:2}}},i={};class r{constructor(e,i={}){this.id="",this.timeEvolutionData={currentTimeValue:0,startTimestampMS:0,offsetTimestampMS:0,timeEvolutionActive:!1},this.displayProperties={origin:i.origin},this.setID(e),"centre"===i.origin&&(i.origin=[Math.round(this.width/2),Math.round(this.height/2)]),t.setupProperties(this,"ResponsiveCanvas",i)}_updateCanvasDimensions(){this.canvasContainer.style.width=`${this.width}px`,this.canvasContainer.style.height=`${this.height}px`,this.backgroundCanvas.width=this.width,this.backgroundCanvas.height=this.height,this.background.translate(this.origin.x,this.origin.y),this._updateBackground(),this.foregroundCanvas.width=this.width,this.foregroundCanvas.height=this.height,this.foreground.translate(this.origin.x,this.origin.y),this._updateForeground()}_updateBackground(){void 0!==this.background&&(this.background.clearRect(-this.origin.x,-this.origin.y,this.width,this.height),this.backgroundFunction&&this.backgroundFunction(this.background,this.timeEvolutionData.currentTimeValue))}_updateForeground(){void 0!==this.foreground&&(this.foreground.clearRect(-this.origin.x,-this.origin.y,this.width,this.height),this.foregroundFunction&&this.foregroundFunction(this.foreground,this.timeEvolutionData.currentTimeValue))}setBackground(t){this.backgroundFunction=t,this._updateBackground()}setForeground(t){this.foregroundFunction=t,this._updateForeground()}setOrigin(...e){1===e.length&&"centre"===e[0]?(t.setAxesProperty(this,"origin","number",Math.round(this.width/2),Math.round(this.height/2)),this.displayProperties.origin="centre"):t.setAxesProperty(this,"origin","number",...e),void 0!==this.backgroundCanvas&&void 0!==this.foregroundCanvas&&this._updateCanvasDimensions()}setID(e){if(void 0!==i[e])throw`Error creating ResponsiveCanvas object: Object with ID "${"string"==typeof e?e:JSON.stringify(e)}" already exists.`;t.setSingleProperty(this,"id","string",e),i[this.id]=this}setBackgroundCSS(t){if("string"!=typeof t)throw`Error setting background CSS for canvas: Unexpected argument ${JSON.stringify(id)}`;void 0!==this.backgroundCanvas&&(this.backgroundCanvas.style.background=t),this.displayProperties.backgroundCSS=t}startTime(){this.timeEvolutionData.timeEvolutionActive=!0,this.timeEvolutionData.startTimestampMS=performance.now(),window.requestAnimationFrame((t=>this._updateTime(t)))}pauseTime(){this.timeEvolutionData.timeEvolutionActive=!1,this.timeEvolutionData.offsetTimestampMS=performance.now()-this.timeEvolutionData.startTimestampMS}stopTime(){this.timeEvolutionData.timeEvolutionActive=!1,this.timeEvolutionData.currentTimeValue=0,this.timeEvolutionData.offsetTimestampMS=0,this._updateForeground()}_updateTime(t){this.timeEvolutionData.timeEvolutionActive&&(this.timeEvolutionData.currentTimeValue=(this.timeEvolutionData.offsetTimestampMS+t-this.timeEvolutionData.startTimestampMS)/1e3,this._updateForeground(),window.requestAnimationFrame((t=>this._updateTime(t))))}}return{activeCanvases:i,ResponsiveCanvas:r,ResponsivePlot2D:class extends r{constructor(e,i={}){super(e,i),t.setupProperties(this,"ResponsivePlot2D",i),this.xLims=[],this.yLims=[],this.plotData={},this._updateLimits(),this.setBackground((t=>{const e=(e,i,r,s,o,a)=>{const n=s%2==0?0:.5,h=this[""+(e+("Ticks"===r?"TickSize":"GridSize"))][i];if(t.lineWidth=s,this[`${e+r}`][i]){t.beginPath();let e=-Math.floor(this.origin[i]/(h*this.gridScale[i]))*h*this.gridScale[i];if("x"===i)for(;e<this.width-this.origin.x;)t.moveTo(e+n,o),t.lineTo(e+n,a),e+=this.gridScale.x*h;else if("y"===i)for(;e<this.height-this.origin.y;)t.moveTo(o,e+n),t.lineTo(a,e+n),e+=this.gridScale.y*h;t.stroke()}};t.lineCap="square",t.strokeStyle="rgb(0, 0, 0)",e("minor","x","Gridlines",1,-this.origin.y,this.height-this.origin.y),e("minor","y","Gridlines",1,-this.origin.x,this.width-this.origin.x),e("major","x","Gridlines",2,-this.origin.y,this.height-this.origin.y),e("major","y","Gridlines",2,-this.origin.x,this.width-this.origin.x),e("minor","x","Ticks",1,-3,3),e("minor","y","Ticks",1,-3,3),e("major","x","Ticks",2,-6,6),e("major","y","Ticks",2,-6,6),t.beginPath(),t.lineWidth=3,t.moveTo(.5,-this.origin.y),t.lineTo(.5,this.height-this.origin.y),t.moveTo(-this.origin.x,.5),t.lineTo(this.width-this.origin.x,.5),t.stroke()}))}_updateLimits(){this.xLims=[-this.origin.x/this.gridScale.x,(this.width-this.origin.x)/this.gridScale.x],this.yLims=[-this.origin.y/this.gridScale.y,(this.height-this.origin.y)/this.gridScale.y]}_updatePlottingData(){this.setForeground(((t,e)=>{for(const i of Object.keys(this.plotData))if(!0===this.plotData[i].visibility){const r=this.plotData[i];if("none"!==r.traceStyle){switch(t.strokeStyle=r.traceColour,t.lineWidth=r.traceWidth,t.lineJoin="round",r.traceStyle){case"solid":t.setLineDash([]);break;case"dotted":t.setLineDash([3,3]);break;case"dashed":t.setLineDash([10,10]);break;case"dashdot":t.setLineDash([15,3,3,3])}const i=r.data(e,this.xLims,this.yLims,.01,r.parameterRange);t.beginPath();for(const e of i)Number.isSafeInteger(Math.round(e[1]))||(e[1]=e[1]>0?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER),t.lineTo(e[0]*this.gridScale.x,-e[1]*this.gridScale.y);t.stroke()}if("none"!==r.markerStyle){const i=r.markerSize;t.strokeStyle=r.markerColour,t.fillStyle=r.markerColour,t.lineWidth=2*i;const s=(()=>{switch(r.markerStyle){case"circle":return(t,e,r)=>{t.arc(e,r,5*i,0,2*Math.PI),t.fill()};case"plus":return(t,e,r)=>{t.moveTo(e,r+5*i),t.lineTo(e,r-5*i),t.moveTo(e+5*i,r),t.lineTo(e-5*i,r),t.stroke()};case"cross":return(t,e,r)=>{t.moveTo(e+5*i,r+5*i),t.lineTo(e-5*i,r-5*i),t.moveTo(e-5*i,r+5*i),t.lineTo(e+5*i,r-5*i),t.stroke()};case"arrow":return(t,e,r,s)=>{isNaN(s)||(t.translate(e,r),t.rotate(-s-Math.PI/2),t.moveTo(0,-7*i),t.lineTo(-5*i,7*i),t.lineTo(5*i,7*i),t.lineTo(0,-7*i),t.fill(),t.rotate(s+Math.PI/2),t.translate(-e,-r))}}})(),o=r.data(e,this.xLims,this.yLims,.001,r.parameterRange);let a=[NaN,NaN];for(const e of o){t.beginPath();const i=[e[0]*this.gridScale.x,-e[1]*this.gridScale.y],r=Math.atan2(i[1]-a[1],-i[0]+a[0]);s(t,...i,r),a=i}}}}))}addData(e,i,r={}){if("string"!=typeof e)throw`Error setting plot data: Unexpected type for ID "${JSON.stringify(e)}"`;if(Array.isArray(i)&&2===i.length)if(Array.isArray(i[0])){if(Array.isArray(i[1])){if(i[0].length!==i[1].length)throw"Error setting plot data: Lengths of data arrays are not equal.";for(let t=0;t<i[0].length;t++){const e="function"==typeof i[0][t]?i[0][t](0):i[0][t],r="function"==typeof i[1][t]?i[1][t](0,0):i[1][t];if("number"!=typeof e||"number"!=typeof r)throw"Error setting plot data: Data arrays contain types which are not numbers."}this.plotData[e]={data:function*(t){for(let e=0;e<i[0].length;e++){const r="function"==typeof i[0][e]?i[0][e](t):i[0][e],s="function"==typeof i[1][e]?i[1][e](r,t):i[1][e];yield[r,s]}}}}else if("function"==typeof i[1]){if("number"!=typeof i[1](0,0))throw"Error setting plot data: Plot function does not return numbers.";for(let t=0;t<i[0].length;t++)if("number"!=typeof i[0][t])throw"Error setting plot data: Data array contains types which are not numbers.";this.plotData[e]={data:function*(t){for(const e of i[0])yield[e,i[1](e,t)]}}}}else"function"==typeof i[0]&&"function"==typeof i[1]&&(this.plotData[e]={data:function*(t,e,r,s,o){let a=e=>i[0](e,t),n=e=>i[1](e,t),h=o[0];for(;h<=o[1];)yield[a(h),n(h)],h+=s;yield[a(h),n(h)]}});else{if("function"!=typeof i)throw`Error setting plot data: Unrecognised data signature ${JSON.stringify(i)}.`;if("number"!=typeof i(0,0))throw"Error setting plot data: Plot function does not return numbers.";this.plotData[e]={data:function*(t,e,r,s){let o=e[0],a=e=>i(e,t);for(;o<=e[1];){for(;!(o>e[1]);){if(a(o)<=r[1]&&a(o)>=r[0]&&!Number.isNaN(a(o))){yield[o-s,a(o-s)];break}o+=s}for(;yield[o,a(o)],!(o>e[1]||a(o)>r[1]||a(o)<r[0]||Number.isNaN(a(o)));)o+=s}}}}t.setupProperties(this.plotData[e],"ResponsivePlot2DTrace",r),this._updatePlottingData()}removeData(t){delete this.plotData[t],this._updatePlottingData()}setOrigin(...t){super.setOrigin(...t),this._updateLimits()}setMajorTicks(...e){t.setAxesProperty(this,"majorTicks","boolean",...e)}setMinorTicks(...e){t.setAxesProperty(this,"minorTicks","boolean",...e)}setMajorTickSize(...e){t.setAxesProperty(this,"majorTickSize","number",...e)}setMinorTickSize(...e){t.setAxesProperty(this,"minorTickSize","number",...e)}setMajorGridlines(...e){t.setAxesProperty(this,"majorGridlines","boolean",...e)}setMinorGridlines(...e){t.setAxesProperty(this,"minorGridlines","boolean",...e)}setMajorGridSize(...e){t.setAxesProperty(this,"majorGridSize","number",...e)}setMinorGridSize(...e){t.setAxesProperty(this,"minorGridSize","number",...e)}setGridScale(...e){t.setAxesProperty(this,"gridScale","number",...e),this._updateLimits(),this._updateForeground()}setXLims(e,i){if(!(i>=e))throw"Error setting xLims: Lower limit cannot be higher than or equal to higher limit.";t.setArrayProperty(this,"xLims","number",[e,i],2),this.gridScale.x=this.width/Math.abs(this.xLims[0]-this.xLims[1]),super.setOrigin(-this.xLims[0]*this.gridScale.x,this.origin.y),this._updateBackground(),this._updatePlottingData()}setYLims(e,i){if(!(i>=e))throw"Error setting yLims: Lower limit cannot be higher than or equal to higher limit.";t.setArrayProperty(this,"xLims","number",[e,i],2),this.gridScale.y=this.height/Math.abs(this.yLims[0]-this.yLims[1]),super.setOrigin(this.origin.x,this.yLims[1]*this.gridScale.y),this._updateBackground(),this._updatePlottingData()}setTraceColour(e,i){t.setPlotDataProperty(this,e,"traceColour",i)}setTraceStyle(e,i){t.setPlotDataProperty(this,e,"traceStyle",i)}setTraceWidth(e,i){t.setPlotDataProperty(this,e,"traceWidth",i)}setMarkerColour(e,i){t.setPlotDataProperty(this,e,"markerColour",i)}setMarkerStyle(e,i){t.setPlotDataProperty(this,e,"markerStyle",i)}setMarkerSize(e,i){t.setPlotDataProperty(this,e,"markerSize",i)}setVisibility(e,i){t.setPlotDataProperty(this,e,"visibility",i)}setParameterRange(e,i,r){if(!(r>=i))throw"Error setting parameterRange: Lower limit cannot be higher than or equal to higher limit.";t.setPlotDataProperty(this,e,"parameterRange",[i,r])}}}}();class e extends t.ResponsivePlot2D{constructor(t,e=null,i={}){super(t,i),i.hasOwnProperty("backgroundCSS")&&this.setBackgroundCSS(i.backgroundCSS),i.hasOwnProperty("xLims")&&this.setXLims(...i.xLims),i.hasOwnProperty("yLims")&&this.setYLims(...i.yLims),null!==e&&this.addData(e.id,e.data,e.options)}}return t.ResponsiveCanvas.prototype.show=function(t){this.containerElement=document.querySelector(t),this.canvasContainer=document.createElement("div"),this.canvasContainer.id=this.id,this.canvasContainer.style.position="relative",this.backgroundCanvas=document.createElement("canvas"),this.foregroundCanvas=document.createElement("canvas"),this.backgroundCanvas.style.position="absolute",this.backgroundCanvas.style.left="0",this.backgroundCanvas.style.top="0",this.backgroundCanvas.id=`${this.id}-background-canvas`,this.foregroundCanvas.style.position="absolute",this.foregroundCanvas.style.left="0",this.foregroundCanvas.style.top="0",this.foregroundCanvas.id=`${this.id}-foreground-canvas`,this.canvasContainer.appendChild(this.backgroundCanvas),this.canvasContainer.appendChild(this.foregroundCanvas),this.containerElement.appendChild(this.canvasContainer),this.background=this.backgroundCanvas.getContext("2d"),this.foreground=this.foregroundCanvas.getContext("2d"),this.width=this.containerElement.clientWidth,this.height=this.containerElement.clientHeight,this.observer=new ResizeObserver((t=>{for(const e of t)this.width=e.target.clientWidth,this.height=e.target.clientHeight,this._updateCanvasDimensions()})),this.observer.observe(this.containerElement);for(const t of Object.keys(this.displayProperties))this[`set${t[0].toUpperCase()}${t.slice(1)}`](this.displayProperties[t])},{core:t,Plot:e,getActivePlots:function(){const e={};for(const i of Object.keys(t.activeCanvases))t.activeCanvases[i]instanceof t.ResponsivePlot2D&&(e[i]=t.activeCanvases[i]);return e}}}();